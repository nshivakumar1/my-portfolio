---
// blogs.astro
import Layout from '../layouts/Layout.astro';
import Parser from 'rss-parser';

// Define a type for the post items
interface SubstackPost {
  title: string;
  link: string;
  pubDate?: string;
  contentSnippet?: string;
  // Add other properties as needed
}

// Create a function to fetch Substack posts with proper error handling
async function getSubstackPosts(): Promise<SubstackPost[]> {
  const parser = new Parser();
  
  // Replace with your actual Substack URL
  // Common formats: https://yoursubstack.substack.com/feed
  const substackUrl = 'https://substack.com/@codeclouddevops/posts';
  
  try {
    const feed = await parser.parseURL(substackUrl);
    return (feed.items as SubstackPost[]) || [];
  } catch (error: unknown) {
    // Properly type the error and handle it
    if (error instanceof Error) {
      console.error(`Error parsing Substack feed: ${error.message}`);
    } else {
      console.error(`Unknown error parsing Substack feed`);
    }
    return []; // Return empty array instead of failing
  }
}

// Get posts with error handling - DECLARE ONLY ONCE
const posts = await getSubstackPosts();
---

<Layout title="Blog Posts">
  <main>
    <h1>Blog Posts</h1>
    
    {posts.length > 0 ? (
      <div class="posts-container">
        {posts.map((post) => (
          <div class="post-card">
            <h2>{post.title}</h2>
            {post.pubDate && (
              <p class="date">
                {new Date(post.pubDate).toLocaleDateString(undefined, {
                  year: 'numeric',
                  month: 'long', 
                  day: 'numeric'
                })}
              </p>
            )}
            {post.contentSnippet && (
              <p>{post.contentSnippet.substring(0, 150)}...</p>
            )}
            <a href={post.link} target="_blank" rel="noopener noreferrer">Read more</a>
          </div>
        ))}
      </div>
    ) : (
      <div class="no-posts">
        <p>No blog posts available at the moment. Check back soon!</p>
      </div>
    )}
  </main>
</Layout>

<style>
  .posts-container {
    display: grid;
    gap: 2rem;
    margin: 2rem 0;
  }
  
  .post-card {
    border: 1px solid #eaeaea;
    border-radius: 8px;
    padding: 1.5rem;
    background-color: #fff;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }
  
  .date {
    color: #666;
    font-size: 0.9rem;
  }
  
  .no-posts {
    text-align: center;
    padding: 3rem 0;
  }
</style>